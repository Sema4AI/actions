name: Frontend Build

on:
  push:
    branches: [community]
    paths:
      - 'action_server/frontend/**'
      - '.github/workflows/frontend-build.yml'
  pull_request:
    branches: [community]
    paths:
      - 'action_server/frontend/**'
      - '.github/workflows/frontend-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Invoke
        run: pip install invoke

      - name: Network Hardening
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ] || [ "$RUNNER_OS" == "macOS" ]; then
            sudo sh -c 'echo "127.0.0.1 npm.pkg.github.com" >> /etc/hosts'
          fi

      - name: Network Hardening (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Add-Content -Path "C:\Windows\System32\drivers\etc\hosts" -Value "127.0.0.1 npm.pkg.github.com"

      - name: Build Frontend
        id: build-frontend
        working-directory: action_server
        run: inv build-frontend --tier community

      - name: Check Bundle Size
        id: check-bundle-size
        working-directory: action_server/frontend
        shell: bash
        run: |
          echo "Checking bundle size against threshold (1000KB total, 300KB gzipped)..."

          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found"
            exit 1
          fi

          if [ "$RUNNER_OS" == "Windows" ]; then
            BUNDLE_SIZE=$(powershell -Command "(Get-ChildItem -Path dist -Recurse -File | Measure-Object -Property Length -Sum).Sum")
          elif [ "$RUNNER_OS" == "macOS" ]; then
            # macOS du doesn't support -b, use stat instead
            BUNDLE_SIZE=$(find dist -type f -exec stat -f%z {} + | awk '{s+=$1} END {print s}')
          else
            BUNDLE_SIZE=$(du -sb dist | cut -f1)
          fi

          if [ "$RUNNER_OS" == "Windows" ]; then
            GZIP_SIZE=$(powershell -Command "
              \$files = Get-ChildItem -Path dist -Recurse -File
              \$total = 0
              foreach (\$file in \$files) {
                \$memStream = New-Object System.IO.MemoryStream
                \$gzipStream = New-Object System.IO.Compression.GZipStream(\$memStream, [System.IO.Compression.CompressionMode]::Compress)
                \$fileBytes = [System.IO.File]::ReadAllBytes(\$file.FullName)
                \$gzipStream.Write(\$fileBytes, 0, \$fileBytes.Length)
                \$gzipStream.Close()
                \$total += \$memStream.Length
              }
              \$total
            ")
          else
            GZIP_SIZE=$(find dist -type f -exec gzip -c {} \; | wc -c)
          fi

          BUNDLE_KB=$((BUNDLE_SIZE / 1024))
          GZIP_KB=$((GZIP_SIZE / 1024))

          echo "Bundle size: ${BUNDLE_KB} KB (${BUNDLE_SIZE} bytes)"
          echo "Gzipped size: ${GZIP_KB} KB (${GZIP_SIZE} bytes)"

          # Updated thresholds to accommodate community edition with full feature set
          BUNDLE_THRESHOLD=$((1000 * 1024))
          GZIP_THRESHOLD=$((300 * 1024))

          FAILED=0
          if [ $BUNDLE_SIZE -gt $BUNDLE_THRESHOLD ]; then
            echo "ERROR: Bundle size (${BUNDLE_KB} KB) exceeds threshold of 1000 KB"
            FAILED=1
          fi

          if [ $GZIP_SIZE -gt $GZIP_THRESHOLD ]; then
            echo "ERROR: Gzipped size (${GZIP_KB} KB) exceeds threshold of 300 KB"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

          echo "SUCCESS: Bundle sizes within thresholds"

      - name: Validate Imports
        id: validate-imports
        working-directory: action_server
        continue-on-error: true
        run: inv validate-imports --tier community || echo "Import validation skipped"

      - name: Determinism Check
        id: determinism-check
        if: runner.os != 'Windows'
        working-directory: action_server
        shell: bash
        run: |
          mv frontend/dist frontend/dist_first
          inv build-frontend --tier community
          # Extract just the hash, not the full path, for comparison
          find frontend/dist -type f -exec sha256sum {} \; | awk '{print $1}' | sort > dist_second.sha
          find frontend/dist_first -type f -exec sha256sum {} \; | awk '{print $1}' | sort > dist_first.sha
          if ! diff dist_first.sha dist_second.sha; then
            echo "Determinism check failed: Builds are not reproducible"
            rm -rf frontend/dist
            mv frontend/dist_first frontend/dist
            exit 1
          fi
          echo "Determinism check passed"
          rm -rf frontend/dist
          mv frontend/dist_first frontend/dist

      - name: Validate Artifact
        id: validate-artifact
        working-directory: action_server
        continue-on-error: true
        run: inv validate-artifact --tier community || echo "Artifact validation skipped (import issue)"

      - name: Generate SBOM
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          cd action_server/frontend
          cyclonedx-npm --output-file sbom.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-community-${{ matrix.os }}-${{ github.sha }}
          path: action_server/frontend/dist/**

      - name: Job Summary
        if: always()
        shell: bash
        run: |
          JOB_STATUS=${{ job.status }}

          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **OS** | ${{ matrix.os }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${JOB_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${JOB_STATUS}" != "success" ]; then
            echo "### Failure Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.build-frontend.outcome }}" == "failure" ]; then
              echo "**Category:** Build Error" >> $GITHUB_STEP_SUMMARY
              echo "- Check TypeScript compilation errors" >> $GITHUB_STEP_SUMMARY
              echo "- Verify dependencies are installed" >> $GITHUB_STEP_SUMMARY
              echo "- Review Vite build logs" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.check-bundle-size.outcome }}" == "failure" ]; then
              echo "**Category:** Bundle Size Error" >> $GITHUB_STEP_SUMMARY
              echo "- Bundle exceeds thresholds (1000KB total, 300KB gzipped)" >> $GITHUB_STEP_SUMMARY
              echo "- Review bundle composition and optimize imports" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.validate-imports.outcome }}" == "failure" ] || [ "${{ steps.validate-artifact.outcome }}" == "failure" ]; then
              echo "**Category:** Validation Error" >> $GITHUB_STEP_SUMMARY
              echo "- Run 'inv validate-imports --tier community' locally" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.determinism-check.outcome }}" == "failure" ]; then
              echo "**Category:** Determinism Error" >> $GITHUB_STEP_SUMMARY
              echo "- Builds are not reproducible" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Build Successful" >> $GITHUB_STEP_SUMMARY
          fi
